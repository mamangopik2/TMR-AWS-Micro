<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Logged Files</title>
    <link rel="stylesheet" href="style.css">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            color: white;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ccc;
            vertical-align: center;
        }

        th {
            background-color: #f2f2f2;
            color: black;
        }

        .container img {
            max-width: 120px;
            margin-bottom: 20px;
        }
    </style>

</head>

<body>
    <div class="dropdown" style="position: absolute; top: 0; left: 2%;">
        <button class="dropdown-button">&#9776;</button>
        <div class="dropdown-content" id="dropdown-buttons">
        </div>
    </div>
    <script src="header-button.js"></script>


    <div class="container" id="container">
        <h2>Logged Files</h2>
        <img src="logo.png" alt="TMR logo">

        <table id="informationTable">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Filename</th>
                    <th>Date</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                <!-- Filled dynamically -->
            </tbody>
        </table>
    </div>

    <div id="loading"
        style="background-color:#222;width: 100%;height: 100%;position: absolute;top: 0;left: 0;z-index: 5;display: block;">
        <h1 style="text-align: center;color: #ccc;">Loading</h1>
    </div>

    <script src="beacon.js"></script>
    <script>
        const base_url = window.location.origin;
        const urlRead = base_url + '/logger-list';
        const sensorTableBody = document.getElementById("informationTable").querySelector("tbody");
        var showLoading = false;
        function filenameToDate(filename) {
            filename = filename.replace(".csv", "");
            console.log(filename);
            const dateMatch = filename.match(/(\d{4}-\d{2}-\d{2})/);

            if (dateMatch) {
                try {
                    const dateString = dateMatch[1]; // "2025-06-12"
                    const date = new Date(dateString); // Create Date object

                    console.log(date.toISOString()); // Example output: "2025-06-12T00:00:00.000Z"
                    console.log(date.toDateString()); // Example output: "Thu Jun 12 2025"
                    return dateString;
                } catch (error) {
                    console.error(error);
                    return filename;
                }
            } else {
                console.log('No date found in the string');
                return filename;
            }
        }
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 1000 } = options;

            return Promise.race([
                fetch(resource),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error("Timeout after 1s")), timeout)
                )
            ]);
        }

        async function loadLoggedFiles() {
            fetchWithTimeout(urlRead, { timeout: 10000 })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    sensorTableBody.innerHTML = "";
                    data.filename.forEach((element, index) => {
                        let fileURL = `${base_url}/${element}`;
                        const row = document.createElement("tr");

                        if (element === '/TMRBuffer.csv') {
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td><a href="${fileURL}">${element}</a></td>
                                <td>${filenameToDate(element)}</td>
                                <td><span >Reserved</span></td>
                            `;
                            sensorTableBody.appendChild(row);
                        } else {
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td><a href="${fileURL}">${element}</a></td>
                                <td>${filenameToDate(element)}</td>
                                <td><span id="dlt-${element}">Delete</span></td>
                            `;
                            sensorTableBody.appendChild(row);
                        }

                        try {

                            document.getElementById(`dlt-${element}`).onclick = () => {
                                console.log("Delete button clicked", element);

                                // Ask for confirmation before deleting
                                const confirmDelete = confirm(`Are you sure you want to delete "${element}"?`);
                                if (!confirmDelete) {
                                    console.log("Delete canceled by user");
                                    return; // Stop if user cancels
                                }

                                showLoading = true;

                                const link = `${base_url}/remove-file?filename=${element}`;
                                fetch(link)
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log(data);
                                        setTimeout(() => {
                                            showLoading = false;
                                            alert(`File "${element}" deleted successfully.`);
                                            loadLoggedFiles(); // Refresh the file list after deletion
                                        }, 3000);
                                    })
                                    .catch(error => {
                                        showLoading = false;
                                        console.error("Error deleting file:", error);
                                        alert("Error deleting file. Check console for details.");
                                    });
                            };
                        } catch (error) {
                            console.log("Error setting delete handler:", error);
                        }
                    });

                })
                .catch(error => {
                    console.error("Fetch error:", error.message);
                    // sensorTableBody.innerHTML = `<tr><td colspan="4" style="color: red;">Error: ${error.message}</td></tr>`;
                });
        }

        // Load immediately and then every 2 seconds
        loadLoggedFiles();


        setInterval(async () => {
            if (showLoading == true) {
                document.getElementById("loading").style.display = "block";
                document.getElementById("container").style.display = "none";

            } else {
                document.getElementById("loading").style.display = "none";
                document.getElementById("container").style.display = "block";
            }
        }, 1000);


        // Navigation
        document.getElementById("button_network").onclick = () => window.location = base_url + '/net-form.html';
        document.getElementById("button_sensors").onclick = () => window.location = base_url + '/sensors.html';
        document.getElementById("button_interfaces").onclick = () => window.location = base_url + '/interfaces.html';
        document.getElementById("button_site_setup").onclick = () => window.location = base_url + '/site_setup.html';
        document.getElementById("button_time_setup").onclick = () => window.location = base_url + '/time_setup.html';
        document.getElementById("button_cloud_setup").onclick = () => window.location = base_url + '/cloud_setup.html';
        document.getElementById("button_OTA").onclick = () => window.location = base_url + '/OTA.html';
        document.getElementById("button_configured_sensor").onclick = () => window.location = base_url + '/data_viewer.html';
        document.getElementById("edit_sensor_list_button").onclick = () => {
            window.location = base_url + '/edit-sensors.html';
        };
    </script>

</body>

</html>